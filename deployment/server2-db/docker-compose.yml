version: '3.8'

services:
  # MySQL 8.0
  mysql:
    image: mysql:8.0
    container_name: datahub-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: DataHub@2025
      MYSQL_DATABASE: datahub
      TZ: Asia/Shanghai
    ports:
      - "3306:3306"
    volumes:
      - /opt/datahub/data/mysql:/var/lib/mysql
      - /opt/datahub/config/mysql.cnf:/etc/mysql/conf.d/custom.cnf
      - /opt/datahub/logs/mysql:/var/log/mysql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max_connections=500
      - --default-authentication-plugin=mysql_native_password
    mem_limit: 3g
    mem_reservation: 2g
    networks:
      - datahub-network

  # PostgreSQL 14
  postgresql:
    image: postgres:14-alpine
    container_name: datahub-postgresql
    restart: always
    environment:
      POSTGRES_PASSWORD: DataHub@2025
      POSTGRES_DB: datahub
      PGDATA: /var/lib/postgresql/data/pgdata
      TZ: Asia/Shanghai
    ports:
      - "5432:5432"
    volumes:
      - /opt/datahub/data/postgresql:/var/lib/postgresql/data
      - /opt/datahub/logs/postgresql:/var/log/postgresql
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=512MB
      - -c
      - effective_cache_size=1GB
    mem_limit: 2g
    mem_reservation: 1g
    networks:
      - datahub-network

  # Redis 6.x
  redis:
    image: redis:6-alpine
    container_name: datahub-redis
    restart: always
    command: redis-server --requirepass DataHub@2025 --maxmemory 1gb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - /opt/datahub/data/redis:/data
      - /opt/datahub/logs/redis:/var/log/redis
    mem_limit: 1g
    mem_reservation: 512m
    networks:
      - datahub-network

  # Zookeeper
  zookeeper:
    image: zookeeper:3.8
    container_name: datahub-zookeeper
    restart: always
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888;2181
      TZ: Asia/Shanghai
    ports:
      - "2181:2181"
    volumes:
      - /opt/datahub/data/zookeeper:/data
      - /opt/datahub/logs/zookeeper:/datalog
    mem_limit: 512m
    networks:
      - datahub-network

networks:
  datahub-network:
    driver: bridge

