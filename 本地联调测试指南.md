# DataHub 本地联调测试指南

## 🎯 测试目标

验证前后端API对接是否正常，所有功能是否可用。

## 📋 准备工作

### 1. 环境检查

确保已安装以下环境：

- ✅ JDK 11+
- ✅ Maven 3.6+
- ✅ Node.js 16+
- ✅ MySQL 8.0+
- ✅ Redis 6.x+ (可选)

### 2. 数据库初始化

```bash
# 进入后端目录
cd /Users/liumingze/DataHub/datahub-backend

# 初始化数据库（请替换为你的MySQL密码）
mysql -u root -p < sql/datahub.sql

# 或者登录MySQL后执行
mysql -u root -p
source /Users/liumingze/DataHub/datahub-backend/sql/datahub.sql
```

### 3. 修改后端配置

编辑 `datahub-backend/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    druid:
      url: jdbc:mysql://localhost:3306/datahub?...
      username: root
      password: 你的MySQL密码  # 修改这里
```

## 🚀 启动服务

### 方式一：分别启动（推荐用于开发调试）

#### 1. 启动后端服务

```bash
# 打开终端1
cd /Users/liumingze/DataHub/datahub-backend

# 方式A：使用Maven直接运行
mvn spring-boot:run

# 方式B：先编译再运行
mvn clean package -DskipTests
java -jar target/datahub-backend.jar
```

后端启动成功后，会看到：

```
========================================
    DataHub 数据中台启动成功！
    接口文档: http://localhost:8080/api/doc.html
    Druid监控: http://localhost:8080/api/druid
========================================
```

#### 2. 启动前端服务

```bash
# 打开终端2
cd /Users/liumingze/DataHub/datahub-frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

前端启动成功后，会看到：

```
  VITE v5.x.x  ready in xxx ms

  ➜  Local:   http://localhost:5173/
  ➜  Network: http://192.168.x.x:5173/
```

### 方式二：使用启动脚本

创建一个启动脚本 `start-all.sh`：

```bash
#!/bin/bash

echo "======================================"
echo "  启动 DataHub 数据中台"
echo "======================================"

# 启动后端
echo "正在启动后端服务..."
cd /Users/liumingze/DataHub/datahub-backend
mvn spring-boot:run &
BACKEND_PID=$!

# 等待后端启动
sleep 10

# 启动前端
echo "正在启动前端服务..."
cd /Users/liumingze/DataHub/datahub-frontend
npm run dev &
FRONTEND_PID=$!

echo ""
echo "======================================"
echo "  服务启动完成！"
echo "======================================"
echo "  后端服务: http://localhost:8080/api"
echo "  前端服务: http://localhost:5173"
echo "  后端PID: $BACKEND_PID"
echo "  前端PID: $FRONTEND_PID"
echo ""
echo "  按 Ctrl+C 停止所有服务"
echo "======================================"

# 等待用户中断
wait
```

## 🧪 功能测试清单

### 1. 登录功能测试

- [ ] 访问 http://localhost:5173
- [ ] 应该自动跳转到登录页面
- [ ] 输入用户名：`admin`
- [ ] 输入密码：`admin123`
- [ ] 点击登录按钮
- [ ] 应该成功登录并跳转到首页

**预期结果**：
- 登录成功提示
- 跳转到首页看板
- 浏览器localStorage中保存了token

**测试API**：
```bash
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'
```

### 2. 首页看板测试

- [ ] 查看统计卡片数据
  - 数据源总数
  - 同步任务数
  - 今日查询次数
  - 数据集数量
- [ ] 数据应该来自后端API，不是测试数据
- [ ] 点击快捷入口，跳转到对应模块

**预期结果**：
- 显示真实的统计数据
- 快捷入口可以正常跳转

**测试API**：
```bash
curl http://localhost:8080/api/dashboard/stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 数据源管理测试

#### 3.1 查看数据源列表

- [ ] 点击左侧菜单"数据源平台"
- [ ] 应该显示数据源列表
- [ ] 默认有3个测试数据源

**测试API**：
```bash
curl http://localhost:8080/api/datasource/list \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 3.2 创建数据源

- [ ] 点击"新增数据源"按钮
- [ ] 填写表单：
  - 数据源名称：测试MySQL
  - 数据库类型：MySQL
  - 主机地址：localhost
  - 端口：3306
  - 数据库名：datahub
  - 用户名：root
  - 密码：你的密码
  - 描述：测试数据源
- [ ] 点击"确定"按钮
- [ ] 应该创建成功并刷新列表

**预期结果**：
- 创建成功提示
- 列表中出现新数据源

#### 3.3 测试连接

- [ ] 点击某个数据源的"测试连接"按钮
- [ ] 应该显示连接测试结果

**预期结果**：
- 如果配置正确，显示"连接测试成功"
- 如果配置错误，显示具体错误信息

#### 3.4 编辑数据源

- [ ] 点击"编辑"按钮
- [ ] 修改数据源信息
- [ ] 点击"确定"保存
- [ ] 应该更新成功

#### 3.5 删除数据源

- [ ] 点击"删除"按钮
- [ ] 确认删除
- [ ] 应该删除成功

### 4. 数据中枢测试

#### 4.1 SQL查询

- [ ] 点击左侧菜单"数据中枢"
- [ ] 选择数据源
- [ ] 输入SQL：`SELECT * FROM sys_user LIMIT 10`
- [ ] 点击"执行查询"
- [ ] 应该显示查询结果

**预期结果**：
- 显示查询结果表格
- 显示列名和数据
- 显示执行时间和行数

**测试API**：
```bash
curl -X POST http://localhost:8080/api/datacap/query \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "datasourceId": 1,
    "sqlContent": "SELECT * FROM sys_user LIMIT 10"
  }'
```

#### 4.2 查询历史

- [ ] 切换到"查询历史"标签
- [ ] 应该显示历史查询记录
- [ ] 可以搜索、分页
- [ ] 可以重新执行、复制SQL、删除

**预期结果**：
- 显示查询历史列表
- 包含SQL内容、执行时间、结果行数等信息

#### 4.3 数据集管理

- [ ] 切换到"数据集管理"标签
- [ ] 应该显示数据集列表
- [ ] 点击"创建数据集"
- [ ] 填写表单并保存
- [ ] 可以查看、刷新、删除数据集

**预期结果**：
- 显示数据集列表
- 创建、刷新、删除功能正常

### 5. 数据库同步测试

#### 5.1 查看同步任务

- [ ] 点击左侧菜单"数据库同步"
- [ ] 应该显示同步任务列表
- [ ] 默认有3个测试任务

**测试API**：
```bash
curl http://localhost:8080/api/sync/page?current=1&size=10 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

#### 5.2 创建同步任务

- [ ] 点击"新建任务"按钮
- [ ] 填写表单：
  - 任务名称：测试同步
  - 源数据源：选择一个
  - 目标数据源：选择另一个
  - 源表名：sys_user
  - 目标表名：sys_user_backup
  - 同步模式：全量同步
- [ ] 点击"确定"保存

**预期结果**：
- 创建成功提示
- 列表中出现新任务

#### 5.3 执行同步任务

- [ ] 点击"执行"按钮
- [ ] 任务状态变为"执行中"
- [ ] 进度条开始显示
- [ ] 等待任务完成

**预期结果**：
- 任务状态变化：pending → running → success
- 进度条从0%到100%
- 显示同步行数

**注意**：
- 执行同步任务需要源表和目标表都存在
- 如果表不存在，会显示错误信息

#### 5.4 停止同步任务

- [ ] 在任务执行中时点击"停止"按钮
- [ ] 任务应该停止执行

#### 5.5 删除同步任务

- [ ] 点击"删除"按钮
- [ ] 确认删除
- [ ] 应该删除成功

## 🐛 常见问题排查

### 1. 后端启动失败

**问题**：端口被占用
```
Port 8080 is already in use
```

**解决**：
```bash
# 查找占用8080端口的进程
lsof -i:8080

# 杀死进程
kill -9 PID
```

**问题**：数据库连接失败
```
Access denied for user 'root'@'localhost'
```

**解决**：
- 检查MySQL是否启动
- 检查用户名密码是否正确
- 检查数据库是否已创建

### 2. 前端启动失败

**问题**：端口被占用
```
Port 5173 is already in use
```

**解决**：
```bash
# 查找占用5173端口的进程
lsof -i:5173

# 杀死进程
kill -9 PID
```

**问题**：依赖安装失败
```
npm install 失败
```

**解决**：
```bash
# 清理缓存
rm -rf node_modules package-lock.json
npm cache clean --force

# 重新安装
npm install
```

### 3. API调用失败

**问题**：401 Unauthorized
```
登录已过期，请重新登录
```

**解决**：
- 重新登录获取新token
- 检查token是否正确传递

**问题**：404 Not Found
```
请求的资源不存在
```

**解决**：
- 检查API路径是否正确
- 检查后端服务是否启动
- 检查后端日志

**问题**：500 Internal Server Error
```
服务器内部错误
```

**解决**：
- 查看后端控制台日志
- 查看后端日志文件
- 检查数据库连接

### 4. 跨域问题

**问题**：CORS错误
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**解决**：
- 后端已配置CORS，应该不会出现此问题
- 如果出现，检查后端 `CorsConfig.java`

### 5. 数据不显示

**问题**：页面空白或数据为空

**解决**：
1. 打开浏览器开发者工具（F12）
2. 查看Console标签，是否有错误信息
3. 查看Network标签，查看API请求和响应
4. 检查后端是否正常返回数据

## 📊 测试报告模板

完成测试后，填写以下报告：

```markdown
# DataHub 本地联调测试报告

## 测试环境
- 操作系统：macOS / Windows / Linux
- JDK版本：
- Node.js版本：
- MySQL版本：
- 测试时间：2025-01-XX

## 测试结果

### 1. 登录功能
- [ ] 通过
- [ ] 失败（原因：）

### 2. 首页看板
- [ ] 通过
- [ ] 失败（原因：）

### 3. 数据源管理
- [ ] 查看列表：通过 / 失败
- [ ] 创建数据源：通过 / 失败
- [ ] 测试连接：通过 / 失败
- [ ] 编辑数据源：通过 / 失败
- [ ] 删除数据源：通过 / 失败

### 4. 数据中枢
- [ ] SQL查询：通过 / 失败
- [ ] 查询历史：通过 / 失败
- [ ] 数据集管理：通过 / 失败

### 5. 数据库同步
- [ ] 查看任务：通过 / 失败
- [ ] 创建任务：通过 / 失败
- [ ] 执行任务：通过 / 失败
- [ ] 停止任务：通过 / 失败
- [ ] 删除任务：通过 / 失败

## 发现的问题
1. 
2. 
3. 

## 总体评价
- [ ] 所有功能正常，可以部署
- [ ] 部分功能有问题，需要修复
- [ ] 主要功能有问题，需要重新开发
```

## 🎯 下一步

测试通过后：

1. ✅ 修复发现的问题
2. ✅ 完善前端API对接（参考《前端API对接指南.md》）
3. ✅ 打包前后端
4. ✅ 部署到服务器
5. ✅ 生产环境测试

## 📚 相关文档

- [后端开发完成说明.md](后端开发完成说明.md)
- [前端API对接指南.md](前端API对接指南.md)
- [datahub-backend/README.md](datahub-backend/README.md)
- [datahub-backend/QUICKSTART.md](datahub-backend/QUICKSTART.md)

